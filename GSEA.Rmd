How consistent are sub-analysis settings across tumor types? Are
settings that give editing in one tumor type likely to also give
editing in other tumor types?

Assess variance across single settings, and combinations of settings.

```{r }
source('~/antigenic_space/bin/init.R')

source(file.path(IE_root, 'continuous_IE_detection_init.R'))

reg_method = 'glm'
reg_method = 'lmp'
reg_method = 'glm_log'
ncores = 40
ncores = 36
ncores = 20
ncores = 8
ncores = 1

source(file.path(IE_root, 'continuous_IE_detection_init.R'))
## We filter based on the p-value of beta_y, which can fairly be
## assumed to be significant.
setting_dtf <-
  compile_all_coef_overview(
    redo = F,
    redo_subanalyses = F,
    check_data_availability = F,
    skip_missing = F,
    # N_downsample_settings = 50,
    ncores = ncores,
    reg_method = reg_method,
    include_non_ds_tallies = T,
    z_normalize = F
  )

# setting_dtf$patient_inclusion_crit
# duplicated(colnames(setting_dtf))
# levels(setting_dtf$LOH_HLA)

source(file.path(IE_root, 'continuous_IE_detection_init.R'))
f_setting_dtf <-
  setting_dtf %>%
  filtering(
    args_list = list(
      min_nz_patients = 100,
      min_project_size = 250,
      intercept_filter_magnitude = 1e-3,
      # max_delta_n_cov = 1,
      # force_positive_intercept = F,
      force_intercept_ge_rc = T,
      # intercept_filter_magnitude = 1e-2,
      intercept_filter_p_val = 1e-3
    )
  )

# source(file.path(IE_root, 'continuous_IE_detection_init.R'))
p_setting_dtf <- pretty_overview_dtf(f_setting_dtf)

test_opt_string_consistency(setting_dtf)
test_opt_string_consistency(f_setting_dtf)
test_opt_string_consistency(p_setting_dtf)
```
  
```{r, warning=FALSE}

```

```{r, warning=FALSE}
source(file.path(IE_root, 'continuous_IE_detection_init.R'))
subset_subanalysis_groups(p_setting_dtf, 
  id_vars = setdiff(id_vars, c('tumor_type', 'focus_allele')))
```

# Visualize the difference in abundance of sub-analysis types per tumor type

```{r }
source('~/antigenic_space/bin/init.R')

l_id_vars <- setdiff(id_vars, c('project_extended', 'tumor_type',
    'VE_threshold', 'expression_threshold')) %>%
  c('RNA_expression')

total_N <-
  prod(map_dbl(c(l_id_vars, 'project_extended'), function(v) setting_dtf[, uniqueN(get(v))]))
# map(l_id_vars, function(v) f_setting_dtf[, unique(get(v))])

# f_setting_dtf <- format_coef_overview(f_setting_dtf)

# source(file.path(IE_root, 'continuous_IE_detection_init.R'))
# out <- recode_RNA_expression(f_setting_dtf)

all_levs <-
  map(l_id_vars, function(v) p_setting_dtf[, c(levels(get(v)),
      unique(get(v)))]) %>%
  unlist() %>%
  unique() %>%
  { . }

var_titles_l <- setNames(names(var_titles), var_titles)

source(file.path(IE_root, 'continuous_IE_detection_init.R'))
settings_tally <- perform_settings_tally(
  dtf = p_setting_dtf,
  id_vars = c(l_id_vars)) %>%
  # .[, 'N_n' := N / max(N), by = project_extended] %>%
  .[, var_print := forcats::fct_recode(var, !!!var_titles_l)] %>%
  # .[, var_print :=
  #   factor(var_print,
  #     levels = p_dat[, quantile(cov_n, .5, na.rm = T),
  #       by = var_print][order(V1)]$var_print)] %>%
  .[, lev := factor(lev, levels = all_levs)]

# settings_tally[, levels(lev)]

# settings_tally$project_extended
p <- ggplot(settings_tally, aes(x = lev, y = project_extended,
    color = frac_observed, size = frac_observed)) +
  geom_point() +
  facet_wrap(~var_print, scale = 'free_x', nrow = 2)  +
  scale_y_discrete(
    labels = parse(text = levels(settings_tally$project_extended))) +
  rotate_x_labels(45) +
  scale_colour_viridis_c(name = 'Fraction observed') +
  scale_size_continuous(guide = 'none', range = c(.5, 2)) +
  xlab('') +
  ylab('') +
  theme(legend.position = 'bottom', legend.direction = 'horizontal')
print_plot_eval(call = print(p),
  width = 12+4, height = 12.4,
  units = 'cm',
  filename = file.path(IE_img_dir, glue::glue('settings_count.pdf')))
```


```{r }
filterings <-
  attr(f_setting_dtf, 'per_step_stats') %>%
  imap(~dplyr::filter(.x, variable == 'overall')) %>%
  purrr::keep(function(x) x$fc < 1) %>%
  imap(~list(
    name = .y,
    before = .x$N_before,
    remaining = .x$N_after)
  ) %>%
  unname() %>%
  { . }


#' Use the dot language to visualize the QC-filtering done
#'
#'
generate_filtering_graph <- function(
  filterings = list(
    list(name = 'QC', remaining = 11000),
    list(name = 'Intercept filtering', remaining = 4000)
  ),
  output_fn = file.path(IE_img_dir, 'filtering_flowchart.svg')) {

  filterings <- unname(filterings)
  nodes <- purrr::imap(filterings,
    ~glue::glue('{letters[.y]} [label="{.x$name}\\nn={.x$remaining}"]'))
  nodes_agg <- paste(nodes, collapse = '\n')
  nodes_hierarchy <- paste(letters[1:length(nodes)], collapse = ' -> ')

  master_template <-
    glue::glue("\\
    digraph L {{
      node [shape=rectangle fontname=Arial];
      {nodes_agg}\\
      {nodes_hierarchy}
    }}
   ")
  dot_file <- tempfile()
  writeLines(master_template, dot_file)
  system(glue::glue('dot -Tsvg {dot_file} > {output_fn}'))
}

generate_filtering_graph(filterings)
```


```{r sankeyfail, eval=F}
## Alluvial/Sankey plot
pacman::p_load('ggalluvial')

source(file.path(IE_root, 'continuous_IE_detection_init.R'))
settings_tally <- perform_settings_tally(
  dtf = f_setting_dtf,
  id_vars = c(l_id_vars)) %>%
  # .[, 'N_n' := N / max(N), by = project_extended] %>%
  .[, var_print := forcats::fct_recode(var, !!!var_titles_l)] %>%
  # .[, var_print :=
  #   factor(var_print,
  #     levels = p_dat[, quantile(cov_n, .5, na.rm = T),
  #       by = var_print][order(V1)]$var_print)] %>%
  .[, lev := factor(lev, levels = all_levs)]


p <- ggplot(as.data.frame(f_setting_dtf),
       aes(y = 1,
         axis1 = focus_allele,
         axis2 = RNA_expression)) +
  geom_alluvium(aes(fill = focus_allele),
    width = 0, knot.pos = 0, reverse = FALSE) +
  geom_stratum(width = 1/8, reverse = FALSE) +
  geom_text(stat = "stratum", aes(label = after_stat(stratum)),
            reverse = FALSE) +
  # scale_x_continuous(breaks = 1:3, labels = c("Survived", "Sex", "Class")) +
  coord_flip()
print_plot_eval(print(p),
  width = 17.4, height = 17,
  filename = file.path(IE_img_dir,
    glue::glue('setting_sankey.png')))
```

# Overview volcanoes

```{r }
source(file.path(IE_root, 'continuous_IE_detection_init.R'))

# summary(f_setting_dtf$perm_delta_pq)
# mean(f_setting_dtf$perm_delta_pq <= .05)
invisible(f_setting_dtf[, 'perm_p' := 1-perm_delta_apq])

plots <-
  list(
    'all' = f_setting_dtf,
    # 'VE=1' = f_setting_dtf[RNA_expression == 'VE=1'],
    # 'TPM=5000' = f_setting_dtf[RNA_expression == 'TPM=5000'],
    # 'No drivers' = f_setting_dtf[patient_inclusion_crit == 'stringent']
    NULL
  ) %>%
  purrr::map(plot_overview_volcano,
    effect_var = 'delta',
    p_var = 'perm_p'
  ) %>%
  purrr::discard(is.null) %>%
  purrr::map(~.x + ylab('Observed delta quantile among permutations') +
    xlab('Delta'))

print_plot_eval(print(plots[[1]] +
    ylab('Permutation p') + xlab('Delta')),
  width = 17.4-1.5, height = 8,
  filename = file.path(IE_img_dir,
    glue::glue('volcano_main.pdf')))

# plot_panel_layout(
#   plots = plots,
#   labels = names(plots)[!sapply(plots, is.null)],
#   h = 8,
#   w = 17.4,
#   ncol = 1, nrow = 1,
#   filename = file.path(IE_img_dir,
#     glue::glue('overview_volcanoes.pdf'))
# )
```

# Random walk enrichment CV

```{r, warning=FALSE, results='asis'}
source(file.path(IE_root,
    'continuous_IE_detection_init.R'))

test_opt_string_consistency(setting_dtf)
test_opt_string_consistency(f_setting_dtf)
test_opt_string_consistency(p_setting_dtf)

all_tts <-
  setdiff(levels(p_setting_dtf$project_extended),
  "Pan*'-'*cancer") %>%
  setdiff(NA) %>%
  setdiff("NA") %>%
  maartenutils::auto_name() %>%
  { . }

# p_setting_dtf$sts_filtering

# CV_settings_wrapper <- function(tts, sort_var = 'delta_n') {
#   tts %>%
#   purrr::map(function(tt) {
#     purrr::map(list('top' = FALSE, 'bottom' = TRUE),
#       function(ranking) {
#         CV_editing(
#           dtf = f_setting_dtf,
#           # sort_var = 'perm_delta_pq',
#           sort_var = 'delta_n',
#           tt = tt,
#           verbose = F,
#           reverse = ranking
#         )
#       }
#     )
#   })
# }
CV_settings_wrapper <- function(tts, sort_var = 'delta_n') {
  tts %>%
  purrr::map(function(tt) {
    CV_editing(
      dtf = f_setting_dtf,
      sort_var = sort_var,
      tt = tt,
      verbose = F,
      reverse = FALSE
    )
  })
}

source(file.path(IE_root, 'continuous_IE_detection_init.R'))
CV_settings_delta <-
  all_tts %>%
  maartenutils::auto_name() %>%
  CV_settings_wrapper(sort_var = 'delta')

test_opt_string_consistency(setting_dtf)
test_opt_string_consistency(f_setting_dtf)
test_opt_string_consistency(p_setting_dtf)

CV_settings_pq <-
  all_tts %>%
  maartenutils::auto_name() %>%
  CV_settings_wrapper(sort_var = 'perm_delta_pq')

# CV_settings_delta[[1]][[2]]$percentile_rank
# CV_settings_delta[[1]][[2]]$sts_filtering
# CV_settings_pq[[1]][[2]]$sts_filtering
```

```{r}
source(file.path(IE_root, 'continuous_IE_detection_init.R'))
plot_lists <- plot_CV_overview(CV_settings_delta)
print_plot_eval(
  print(wrap_plots(plot_lists, nrow = length(plot_lists))),
  width = 17.4, 
  # height = 25,
  height = 15,
  filename = file.path(IE_img_dir,
    glue::glue('settings_IE_GSEA_delta.pdf'))
)

plot_lists <- plot_CV_overview(CV_settings_pq)
print_plot_eval(
  print(wrap_plots(plot_lists, nrow = length(plot_lists))),
  width = 17.4, height = 15,
  filename = file.path(IE_img_dir,
    glue::glue('settings_IE_GSEA_pq.pdf')))
```

Relationhip between ES inside and outside tumor types

```{r, eval=F}
source(file.path(IE_root, 'continuous_IE_detection_init.R'))

plots <- plot_CV_results(CV_settings_delta)
multi_page_patchwork(
  plots = plots,
  ncol = 1, nrow = 2,
  filename = file.path(IE_img_dir, 'CV_delta.pdf')
)

plots <- plot_CV_results(CV_settings_pq)
multi_page_patchwork(
  plots = plots,
  ncol = 1, nrow = 2,
  filename = file.path(IE_img_dir, 'CV_pq.pdf')
)
```

Supplemental:
How often is delta pulled upwards by the permutation distribution and
how far?

```{r }
# f_setting_dtf$patient_inclusion_crit
source(file.path(IE_root, 'continuous_IE_detection_init.R'))

plots <-
  list(
    'All sub-analyses' = f_setting_dtf,
    'VE=1 sub-analyses' = f_setting_dtf[RNA_expression == 'VE=1'],
    'TPM=5000 sub-analyses' = f_setting_dtf[RNA_expression == 'TPM=5000'],
    'Stringent patient inclusion sub-analyses' = f_setting_dtf[patient_inclusion_crit == 'stringent']
  ) %>%
  purrr::imap(~plot_delta_perm_relationship(dtf = .x, title = .y))

# print_plot_eval(print(p),
#   width = 17.4, height = 10,
#   filename = file.path(IE_img_dir, 'delta_perm_relationship.pdf'))
plot_panel_layout(
  plots = plots,
  # labels = names(plots)[!sapply(plots, is.null)],
  labels = NULL,
  ncol = 2, nrow = 3,
  filename = file.path(IE_img_dir,
    glue::glue('subanalysis_delta_v_delta_perm.pdf'))
)
```

The more 'rare' kinds of sub-analyses perhaps seem enriched for ones
indicating editing

```{r, eval=F}
l_id_vars <- c('overlap_var', 'analysis_idx',
  'patient_inclusion_crit', 'LOH_HLA', 'analysis_name',
  'project_extended', 'reg_method', 'z_normalize')

p_dat <-
  f_setting_dtf[, .(
    'mean_delta' = mean(delta_n, na.rm = T),
    'var_delta' = var(delta_n, na.rm = T),
    'N' = .N),
    by = l_id_vars] %>%
  # .[N >= 2] %>%
  .[, 'frac_observed' :=
    N / length(unique(f_setting_dtf$project_extended))] %>%
  { . }

p <-
  p_dat[, .(type = c('CI_l', 'mean', 'CI_h'),
  mean_CI(mean_delta)), keyby = .(project_extended, N)] %>%
  as_tibble() %>%
  tidyr::pivot_wider(
    names_from = type, values_from = V2) %>%
  ggplot(aes(x = N, y = mean, ymin=CI_l, ymax=CI_h)) +
  geom_hline(yintercept = 0) +
  geom_pointrange(size = .1) +
  geom_smooth() +
  coord_cartesian(ylim = c(-1, 1)) +
  facet_wrap(~project_extended, labeller = label_parsed) +
  xlab('# focus alleles')

print_plot_eval(print(p),
  width = 17.4, height = 10,
  # width = 8.7, height = 8,
  filename = file.path(IE_img_dir,
    glue::glue('setting_delta_as_function_of_setting_N.pdf')))
```


Parameter sensitivity analysis: which parameters change delta the
most, keeping all other settings constant?

```{r }
source(file.path(IE_root, 'continuous_IE_detection_init.R'))
param_sensitivity(f_setting_dtf,
  method = 'cov',
  fn = file.path(IE_img_dir,
    glue::glue('cov_parameter_sensitivity.pdf')))

source(file.path(IE_root, 'continuous_IE_detection_init.R'))
param_sensitivity(f_setting_dtf,
  method = 'iqr',
  fn = file.path(IE_img_dir,
    glue::glue('iqr_parameter_sensitivity.pdf')))

source(file.path(IE_root, 'continuous_IE_detection_init.R'))
large_tts <- c('Lung~adeno', "Pan*'-'*cancer", 'Melanoma',
  "Head~and~neck~HPV^{'-'}")
param_sensitivity(f_setting_dtf[!project_extended %in% large_tts],
  fn = file.path(IE_img_dir,
    glue::glue('cov_parameter_sensitivity_small.pdf')))

source(file.path(IE_root, 'continuous_IE_detection_init.R'))
param_sensitivity(f_setting_dtf[project_extended %in% large_tts],
  fn = file.path(IE_img_dir,
    glue::glue('cov_parameter_sensitivity_large.pdf')))
```

Validate the previous results visually

```{r }
source(file.path(IE_root, 'continuous_IE_detection_init.R'))

test_opt_string_consistency(f_setting_dtf)
test_opt_string_consistency(p_setting_dtf)

source(file.path(IE_root, 'continuous_IE_detection_init.R'))

track_sum_stats_as_function_of_var(
  # t_dat = p_setting_dtf,
  t_dat = p_setting_dtf[project_extended %in% 
    c('Glioblastoma', 'Breast~LumA')],
  track_var = 'focus_allele',
  response_vars = c('delta', 'perm_delta_pq'),
  twoD_sens_analysis_only = F,
  restrict_highest_level = F,
  no_STS = F,
  redo = T
  # fn = file.path(IE_img_dir,
  #     glue('controlled_setting_titration\\
  #       focus_allele-all.pdf'))
)


source(file.path(IE_root, 'continuous_IE_detection_init.R'))
l_dtf <- 
  p_setting_dtf[RNA_expression %in% c('none', 'TPM=0', 'TPM=50', 'VE=0')]
track_sum_stats_as_function_of_var(
  # t_dat = p_setting_dtf,
  t_dat = l_dtf[project_extended %in% c('Glioblastoma',
    'Breast~LumA')],
  track_var = 'RNA_expression',
  response_vars = c('delta', 'perm_delta_pq'),
  twoD_sens_analysis_only = F,
  restrict_highest_level = F,
  no_STS = F,
  redo = T
  # fn = file.path(IE_img_dir,
  #     glue('controlled_setting_titration\\
  #       focus_allele-all.pdf'))
)

test_opt_string_consistency(f_setting_dtf)
test_opt_string_consistency(p_setting_dtf)
```

```{r, warning=FALSE}
track_sum_stats_as_function_of_var(
  t_dat = f_setting_dtf,
  track_var = 'patient_inclusion_crit',
  response_vars = c('intercept', 'rc', 'delta_n'),
  twoD_sens_analysis_only = F,
  restrict_highest_level = F,
  no_STS = F,
  redo = T
)

track_sum_stats_as_function_of_var(
  t_dat = f_setting_dtf,
  track_var = 'LOH_HLA',
  response_vars = c('intercept', 'rc', 'delta_n'),
  twoD_sens_analysis_only = F,
  restrict_highest_level = F,
  no_STS = F,
  redo = T
)

f_setting_dtf$RNA_expression <- NULL
source(file.path(IE_root, 'continuous_IE_detection_init.R'))
f_setting_dtf <- drop_high_VE(f_setting_dtf)
track_sum_stats_as_function_of_var(
  t_dat = f_setting_dtf,
  track_var = 'VE_threshold',
  response_vars = c('perm_delta_pq', 'delta'),
  twoD_sens_analysis_only = F,
  restrict_highest_level = F,
  no_STS = F,
  redo = T
)
```


